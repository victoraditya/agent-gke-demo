# Local Testing Guide

This guide explains how to run and test the Agentic AI application locally on your machine before deploying to GKE.

## Prerequisites

1.  **Python 3.10+**: Ensure you have Python installed (`python3 --version`).
2.  **Google Cloud SDK**: You need `gcloud` installed and authenticated.
3.  **GCP Project**: You must have a GCP project with Vertex AI API enabled.

## Step 1: Authenticate Locally (CRITICAL)

**Important**: Running `gcloud init` is NOT enough. You must generate Application Default Credentials (ADC) for the Python libraries to work.

```bash
gcloud auth application-default login
```
*   This opens a browser window. Log in with the Google account associated with your GCP project.
*   It creates a JSON credential file at `~/.config/gcloud/application_default_credentials.json`.
*   If you don't do this, you will see a `Your default credentials were not found` error.

gcloud auth application-default login --no-browser
```
Copy the long URL into your browser, authorize, and paste the code back into the terminal.

### Alternative: Service Account (Recommended if above fails)
If the browser flow fails, use a Service Account:

1.  **Create Service Account & Key** (I have already done this for you):
    *   Created SA `local-dev-sa`.
    *   Downloaded key to `key.json`.

2.  **Set Environment Variable**:
    ```bash
    export GOOGLE_APPLICATION_CREDENTIALS=$(pwd)/key.json
    ```

3.  **Run the App**:
    ```bash
    python main.py
    ```

## Step 2: Set Up Virtual Environment

It's best practice to use a virtual environment to isolate dependencies.

```bash
# Create virtual environment
python3 -m venv venv

# Activate it
source venv/bin/activate
```

## Step 3: Install Dependencies

Install the required Python libraries from `requirements.txt`.

```bash
pip install -r requirements.txt
```

## Step 4: Run the Application
 
 Start the Flask server.
 
 ```bash
 # Set the GCP Project ID and Location environment variables for ADK
 export GOOGLE_CLOUD_PROJECT=agent-gke-demo
 export GOOGLE_CLOUD_LOCATION=us-central1
 
 # Enable Vertex AI for ADK
 export GOOGLE_GENAI_USE_VERTEXAI=true
 
 # Run the app
 python main.py
 ```
*   You should see output like `Running on http://0.0.0.0:8080`.

## Step 5: Test with cURL

Open a **new terminal window** (keep the app running in the first one) and send a request to your local server.

```bash
curl -X POST http://localhost:8080/run-agents \
  -H "Content-Type: application/json" \
  -d '{"topic": "The Future of Artificial Intelligence"}'
```

**Expected Output:**
You should receive a JSON response containing:
*   `topic`: The topic you sent.
*   `research_summary`: A summary generated by the Researcher Agent.
*   `blog_post`: A blog post written by the Writer Agent based on the summary.

## Troubleshooting

*   **403 Permission Denied**: Ensure you ran `gcloud auth application-default login` and that your user has `Vertex AI User` role in the GCP project.
*   **Quota Exceeded**: If you hit rate limits, wait a minute and try again. `gemini-1.5-flash` has generous free tier limits.

## Cost Optimization & Cleanup (Important!)

To avoid incurring unexpected charges from Google Cloud, **delete your cluster** when you are done testing.

### 1. Delete the GKE Cluster
This will remove the cluster and the associated Load Balancer (which costs money).

```bash
gcloud container clusters delete <YOUR_CLUSTER_NAME> --zone <YOUR_ZONE>
```
*Example: `gcloud container clusters delete agent-cluster --zone us-central1-a`*

### 2. Delete Artifact Registry Images (Optional)
Storage costs are low, but you can delete the images if you want to be thorough.

```bash
gcloud artifacts repositories delete agent-repo --location=us-central1
```
